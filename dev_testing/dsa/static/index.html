<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DSA OSD Annotations DevEnv</title>
    <!-- Include Jquery and Jquery UI from CDN -->
    <script src="https://code.jquery.com/jquery-2.1.4.js" type="text/javascript"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js" type="text/javascript"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-k2/8zcNbxVIh5mnQ52A0r3a6jAgMGxFJFE2707UxGCk= sha512-ZV9KawG2Legkwp3nAlxLIVFudTauWuBpC10uEafMHYL0Sarrz5A7G79kXh5+5+woxQ5HM559XX2UZjMJ36Wplg==" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" media="screen" href="https://code.jquery.com/ui/1.11.4/themes/start/jquery-ui.css" />
    <!-- Include Bootstrap from CDN -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js" crossorigin="anonymous"></script>
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    
     <link href="openseadragon_annotations/bootstrap-switch.css" rel="stylesheet" crossorigin="anonymous">
      <script src="static/bower_components/openseadragon-annotations/dist/openseadragon-annotations.min.js"></script> 
    <!-- Right now building against 2.1.0 -->
    <script src="/static/js/openseadragon.min.js"></script>
    <!-- These are the annotation files in the src directory that serve as the basic for OSD annotations -->
    <script type="text/javascript" src="openseadragon_annotations/annotations.js"></script>
    <script type="text/javascript" src="openseadragon_annotations/annotationState_control_functions.js"></script>
    <script type="text/javascript" src="openseadragon_annotations/openseadragon_setup_functions.js"></script>
    <script type="text/javascript" src="openseadragon_annotations/bootstrap-switch.js"></script>
    <script type="text/javascript" src="openseadragon_annotations/mousetrap.min.js"></script>
    <script type="text/javascript" src="openseadragon_annotations/colornames_to_hex_hash.js"></script>
    <!--
   // <link rel="stylesheet" type="text/css" media="screen" href="static/css/jquery-ui.min.css" />
    // <link rel="stylesheet" type="text/css" media="screen" href="static/css/jquery-ui.theme.css" />
    // <link rel="stylesheet" type="text/css" media="screen" href="static/css/jquery-ui.structure.css" />
    // <link rel="stylesheet" type="text/css" media="screen" href="static/css/jquery.dataTables.css" />
    // <script src="//code.jquery.com/jquery-1.11.1.min.js" type="text/javascript"></script>
    // <script src="//code.jquery.com/ui/1.11.1/jquery-ui.min.js" type="text/javascript"></script>
    // <script src="js/bootstrap.min.js" type="text/javascript"></script>
    // <script src="js/jquery.dataTables.min.js" type="text/javascript"></script>
    // 
    //
    // <script type="text/javascript" src="osd-filters/osd_filters.js"></script>
        -->
    <style>
    body {
        margin: 0px;
        padding: 0px;
        -webkit-touch-callout: none;
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
		overflow:hidden;

    }
    
    #cur_color {
        width: 30px;
        height: 30px;
        background-color: #00FF00;
        border: 2px solid black;
        display: inline-block;
        margin-bottom: -15px;
    }
    
    #image_zoomer {
        width: 100%;
        height: 500px;
        color: #333;
    }
    
    #sel_image_frame {
        /*padding-left: 10px;*/
        height: 100%;
    }
    
    #sel_image_scroll {
        overflow: scroll;
        padding: 5px;
    }
    
    #sel_image {
        width: 100%;
        height: 100%;
    }
    /* Sticky footer styles
-------------------------------------------------- */
    
    html {
        position: relative;
        min-height: 100%;
    }
    
    body {
        /* Margin bottom by footer height */
        margin-bottom: 60px;
		padding-top: 50px;
    }
    
    .footer {
        position: absolute;
        bottom: 0;
        width: 100%;
        /* Set the fixed height of the footer here */
        height: 60px;
        background-color: #f5f5f5;
    }
    /* Custom page CSS
-------------------------------------------------- */
    /* Not required for template or sticky footer method. */
    
    body > .container {
        padding: 60px 15px 0;
    }
    
    .container .text-muted {
        margin: 20px 0;
    }
    
    .footer > .container {
        padding-right: 15px;
        padding-left: 15px;
    }
    
    code {
        font-size: 80%;
    }
    
    #status_bar {
        background-color: #666;
        border-top: 1px solid #999;
        /*border-bottom: 1px solid #000;*/
        width: 100%;
        color: #eee;
        position: absolute;
        bottom: -2px;
        left: 0px;
        height: 28px;
        padding: 10px;
    }
    
    #status_label {
        margin-left: 10px;
    }
    </style>
</head>

<body>
    <script>
    base_host = "http://cancer.digitalslidearchive.emory.edu"
    datagroup_apiurl = base_host + '/api/v1/collections';

    function handleResize() {

        console.log('resize');

        // this is expensive, easier to just save these long term, but oh well.
        //Not sure I need this with the new bootstrap code...
        var nav_height = $(".navbar").height();
		var footer_height = $("#footer").height();
        var status_bar_height = $('#status_bar').height();
        var select_patient_height = $("#sel_patient").height();
        var left_width = $('#sel_image_frame').width();

        console.log(nav_height, status_bar_height, select_patient_height, left_width);

        $('#sel_image_scroll').height(window.innerHeight - (nav_height + status_bar_height + select_patient_height + 70));
		
        //$('#zoom_frame').width(window.innerWidth - left_width - 10);
		//$('#zoom_frame').text("Window: " + window.innerWidth +" Left: "+ left_width);
        //$('#image_zoomer').width(window.innerWidth - left_width - 10);
        //$('#image_zoomer').height(window.innerHeight - (nav_height + status_bar_height));
		

		//$('#image_zoomer').height(window.innerHeight - (nav_height + status_bar_height + select_patient_height + footer_height) - 200);

        $('.openseadragon-container').height(window.innerHeight - (nav_height + status_bar_height));
    }


    window.onresize = handleResize;



    sample_file_info = {
        'filename': 'TCGA-2H-A9GG-11A-01-TS1',
        'filename_url': 'http://node15.cci.emory.edu/cgi-bin/iipsrv.fcgi?DeepZoom=/PYRAMIDS/PYRAMIDS/CDSA/GBM_Frozen/intgen.org_GBM.tissue_images.3.0.0/TCGA-06-0137-01A-02-BS2.svs.dzi.tif.dzi',
        'file_thumbnail': 'http://node15.cci.emory.edu/cgi-bin/iipsrv.fcgi?FIF=/PYRAMIDS/PYRAMIDS/CDSA/GBM_Frozen/intgen.org_GBM.tissue_images.3.0.0/TCGA-06-0137-01A-02-BS2.svs.dzi.tif&WID=200&CVT=jpeg'
    }



    //base_host='';    
    //Defining urls for data grab functions //This could be changed for testing to other datasets
    </script>

	<!-- Fixed navbar -->
	<nav class="navbar navbar-default navbar-fixed-top">
        <div class="container-fluid">
            <div class="navbar-header">
                <a class="navbar-brand" href="#"></a>
                    <a class="navbar-brand" href="#">
						<img src="static/imgs/CDSA_Slide_50.png" style="float:left;margin-top:-10px" height="40" />
						DSA Annotations DevSite
					</a>
            </div>
        </div>
    </nav>
    
	<!-- Begin page content -->
	<div class="container-fluid">
		<!--Row #1: image thumbnail, image viewer and zoom-->
		<div class="row">
			<div class="col-md-3 sidebar" id="sel_image_frame">
				<div id="sel_image" class="">
                	Image Selector Should Go Here
                    <img id="thumbnail_img" src=""/>
                    <a class="btn btn-small sel_image_action pull-right">
                    	<span class="icon-fullscreen"></span>
                    </a>
				</div>
			</div>

            <div class="col-md-9" id="zoom_frame">
            	<div class="btn-group">
                	<input type="button" id="show_filter" value="Apply Filters" class="btn btn-small btn-inverse">
                    <input type="button" id="show_debug" value="Show Debug Info" class="btn btn-small btn-inverse">
                    <input type="button" id="show_annotator" value="Draw Tools" class="btn btn-small btn-inverse">
                    <input type="button" id="show_annotations" value="Annotations" class="btn btn-small btn-inverse">
				</div>
				<div id="image_zoomer"></div>
			</div>
		</div>
	</div>

    <footer class="navbar navbar-default navbar-fixed-bottom">
        <div class="container-fluid">
            Place sticky footer content here.
        </div>
    </footer>
   
    <script>
    var config;
    var study_name = [];
    var recent_study_name;
    var viewer;
    var annotationState;
    var pid;
    var patient_data = {};
    var current_filename;
    var current_slide_url;
    var mousetracker;
    var PRECISION = 3;

    $(document).ready(function() {

        //create the filter dialog  as a model
        $("#filter_dialog").dialog({
            autoOpen: false,
            width: 'auto'
        });
        //Filter dialog only opens on click....
        $('#show_filter').click(function() {
            $('#filter_dialog').dialog('open');
            return false;
        });

        $("#debug_dialog").dialog({
            autoOpen: false,
            width: 'auto'
        });
        $("#show_debug").click(function() {
            $("#debug_dialog").dialog('open');
            return false;
        });

        $("#annotation_list_dialog").dialog({
            autoOpen: false,
            width: 'auto'
        });
        $("#show_annotations").click(function() {
            $("#annotation_list_dialog").dialog('open');
            return false;
        });

        $("#annotation_dialog").dialog({
            autoOpen: false,
            width: 'auto'
        });
        $("#show_annotator").click(function() {
            $("#annotation_dialog").dialog('open');

            //annotation_setup_code();
            console.log('annotation code loaded');
            return false;
            //come back here
        });

        //     $("#filter_dialog").html(color_filter_html); ///Loads the color filter selection for the disabled
    });

    $(function() {
		// initialize the image viewer and annotation state
        viewer = OpenSeadragon({
            id: "image_zoomer",
            prefixUrl: "static/imgs/",
        });

        viewer.addHandler('open-failed', function(evt) {
            console.log('tile source opening failed', evt);
        });

        viewer.addHandler('animation', function() {
            var bounds = viewer.viewport.getBounds();
            var message = bounds.x + ':' + bounds.y + ':' + bounds.width + ':' + bounds.height;
            $('.wsi-toolbar').text(message);
        });

        var annotationState = window.annotationState = new AnnotationState();
        annotationState.setSeadragonViewer(viewer);
        annotation_setup_code(annotationState);

        load_image(sample_file_info);

        //Make safer by passing dialog to add to?
        function addAnnot(annotationState, annot) {
            $("#annotation_list_table").append(
                $("<tr>").attr('id', 'annot_' + annot.data.index).data("annot_index", annot.data.index).data("annot_obj", annot).append(
                    $("<td>").html(annot.data.type)
                ).append(
                    $("<td>").html(annot.data.label)
                ).append(
                    $("<td>").append(
                        $("<button>").on("click", function() {
                            $(this).parent().parent().data("annot_obj").detach();
                            for (i = 0; i < annotationState.annotations.length; i++)
                                if (annotationState.annotations[i])
                                    if (annotationState.annotations[i].data.index == $(this).parent().parent().data("annot_index"))
                                        annotationState.annotations[i] = null;
                            if (!annotationState.annotations[annotationState.annotations.length - 1])
                                annotationState.annotations.length -= 1;
                            $(this).parent().parent().remove();
                        }).html("Remove")
                    )
                )
            );

            //To change color, only for rectangle and circle as of now
            //TODO change color names to color codes if needed
            if (annot.data.type == 'rect' || annot.data.type == 'circle'){
            	var col;
                $("#annot_" + annot.data.index).append(
                    $("<td>").append(
                        $("<select>").append(
                        	$("<option>").attr("value","#FF0000").html("&nbsp;&nbsp;").css("background-color","#FF0000")
                        ).append(
                        	$("<option>").attr("value","#00FF00").html("&nbsp;&nbsp;").css("background-color","#00FF00")
                        ).append(
                        	$("<option>").attr("value","#0000FF").html("&nbsp;&nbsp;").css("background-color","#0000FF")
                        ).append(
                        	$("<option>").attr("value","#FFFF00").html("&nbsp;&nbsp;").css("background-color","#FFFF00")
                        ).on("change", function() {
                            $(this).parent().parent().data("annot_obj").element.style.borderColor = this.value;
                            $(this).parent().parent().data("annot_obj").data.color = this.value;
                            $(this).css("background-color",this.options[this.selectedIndex].style.backgroundColor);
                        }).css("background-color",annot.data.color)
                    )
                );
            }
            else
            	$("#annot_" + annot.data.index).append(
                    $("<td>")
                );
            
            $("#annot_" + annot.data.index).append(
            	$("<td>").html(annot.data.browser_info)
            ).append(
            	$("<td>").html(new Date(annot.data.annotation_timestamp))
            );
        }

        $(annotationState).on("annotationAdded", function(e) {
            addAnnot(annotationState, e.annotation);
        });

        $(annotationState).on("allAnnotationsChanged", function() {
            $("#annotation_list_header").siblings().remove();
            for (var i = 0; i < annotationState.annotations.length; i++)
                addAnnot(annotationState, annotationState.annotations[i]);
        });

        function showMouse(event) {
            // getMousePosition() returns position relative to page,
            // while we want the position relative to the viewer
            // element. so subtract the difference.
            var pixel = OpenSeadragon.getMousePosition(event).minus(OpenSeadragon.getElementPosition(viewer.element));
            document.getElementById("mousePixels").innerHTML = toString(pixel, true);

            if (!viewer.isOpen()) {
                return;
            }
            var point = viewer.viewport.pointFromPixel(pixel);
            document.getElementById("mousePoints").innerHTML = toString(point, true);
        }

        // showMouse doesn't exist, commented this out - jake
        OpenSeadragon.addEvent(viewer.element, "mousemove", showMouse);
        mousetracker = new OpenSeadragon.MouseTracker({
            element: viewer.element,
            clickTimeThreshold: 50,
            clickDistThreshold: 50,
            moveHandler: function(event) {
                console.log(event.position);
            }
        });
        //console.log(mousetracker);



    });


    function load_image(image_info_object) {

        image_url = image_info_object.filename_url;
        annotationState.clearAnnotations();
        viewer.open(image_url);

        current_filename = image_info_object.filename;
        current_slide_url = image_info_object.image_url;
        current_thumb = image_info_object.file_thumbnail;
        $("#thumbnail_img").attr('src', current_thumb)



    }

    /*Adding code for a floating debug window... */
    $('#annotationState_dialog').dialog({
        autoOpen: false,
        modal: false,
        draggable: true,
        width: 550,
        height: 375,
    });

    $('#AnnotationDialogButton').on('click', function() {
        $('#annotationState_dialog').dialog('open');
    });

    /* This second debug window displays the color and shape that was selected */
    $('#annotationControlPanel_dialog').dialog({
        autoOpen: false,
        modal: false,
        draggable: true,
        width: 575,
        height: 375,
    });

    $('#AnnotationControlButton').on('click', function() {
        $('#annotationControlPanel_dialog').dialog('open');
    });

    //  window.annotationStateControls = new AnnotationStateControl();
    </script>
    <!-- This serves as the landing spot for the SVG color filter code -->
    <div id="filter_dialog" title="Apply Filters">
        Filter set will appear here
    </div>
    <div id="annotation_dialog"></div>
    <div id="annotation_list_dialog">
        <table id="annotation_list_table" border="5">
            <tr id="annotation_list_header">
                <th>Type</th>
                <th>Label</th>
                <th></th>
                <th>Color</th>
                <th>Browser</th>
                <th>TimeStamp</th>
            </tr>
        </table>
    </div>
    <div id="debug_dialog">
        <span id="mouse_nav_box">
            <div id="wsi_toolbar ">
                <table id="output " style="border:1px solid black; float:right ">
                    <tr>
                        <th class="name ">&nbsp;</th>
                        <th class="value ">Pixels</th>
                        <th class="value ">Points</th>
                    </tr>
                    <tr>
                        <th>Mouse position</th>
                        <td id="mousePixels">-</td>
                        <td id="mousePoints">-</td>
                    </tr>
                    <tr>
                        <th>Image Size</th>
                        <td id="dziSizePixels">-</td>
                        <td id="dziSizePoints"></td>
                    </tr>
                </table>
        </span>
    </div>
</body>

</html>
